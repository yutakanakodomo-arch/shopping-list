<!DOCTYPE html>

<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆ</title>
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' fill='%233D7A78'/%3E%3Ctext x='90' y='82' font-family='sans-serif' font-size='36' font-weight='bold' fill='white' text-anchor='middle'%3E%E8%B2%B7%E3%81%84%E7%89%A9%3C/text%3E%3Ctext x='90' y='130' font-family='sans-serif' font-size='36' font-weight='bold' fill='white' text-anchor='middle'%3E%E3%83%AA%E3%82%B9%E3%83%88%3C/text%3E%3C/svg%3E">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --teal:      #3D7A78;
      --teal-lt:   #5A9E9C;
      --teal-pale: #EAF4F4;
      --warm1:     #E8833A;  /* ã‚ªãƒ¬ãƒ³ã‚¸ */
      --warm2:     #D4A843;  /* ã‚´ãƒ¼ãƒ«ãƒ‰ */
      --warm3:     #C06B3D;  /* ãƒ†ãƒ©ã‚³ãƒƒã‚¿ */
      --green:     #5A9E7A;  /* ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ */
      --bg:        #F7F5F2;
      --dark:      #2D2D2D;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    html { scroll-behavior:smooth; }
    body {
      font-family:'Noto Sans JP',sans-serif;
      background:var(--bg);
      min-height:100vh;
      padding-bottom:48px;
    }


/* ========== HEADER ========== */
.header {
  background:#3D7A78;
  border-bottom:none;
  position:sticky; top:0; z-index:100;
  padding:0 18px;
}

/* ã‚¿ã‚¤ãƒˆãƒ«è¡Œ */
.header-title-row {
  display:flex; align-items:center; justify-content:space-between;
  padding:14px 0 10px;
  border-bottom:1px solid rgba(255,255,255,0.15);
}
.header-title {
  font-family:'Noto Sans JP',sans-serif;
  font-size:16px; font-weight:700; letter-spacing:0.08em;
  color:white;
}
.header-title span {
  font-size:10px; letter-spacing:0.14em;
  color:rgba(255,255,255,0.6); font-weight:300; margin-left:8px;
  vertical-align:middle;
}

/* çµ±è¨ˆ */
.stats-mini {
  display:flex; gap:14px; align-items:center;
}
.stat-item {
  display:flex; flex-direction:column; align-items:center; gap:1px;
}
.stat-num {
  font-family:'Noto Sans JP',sans-serif;
  font-size:17px; font-weight:700; line-height:1; color:white;
}
.stat-lbl {
  font-size:9px; font-weight:300; color:rgba(255,255,255,0.6); letter-spacing:0.08em;
  font-family:'Noto Sans JP',sans-serif;
}
.stat-sep { width:1px; height:22px; background:rgba(255,255,255,0.2); }

/* PROGRESS */
.progress-bg {
  height:3px; background:rgba(255,255,255,0.2); overflow:hidden;
  margin:0 -18px;
}
.progress-bar {
  height:100%;
  background:rgba(255,255,255,0.8);
  transition:width 0.5s ease;
}

/* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¡Œ */
.header-filter-row {
  display:flex; gap:10px; align-items:center;
  padding:9px 0;
  border-bottom:1px solid rgba(255,255,255,0.15);
}
.filter-label {
  font-size:10px; font-weight:300; color:rgba(255,255,255,0.6);
  letter-spacing:0.08em; white-space:nowrap;
  font-family:'Noto Sans JP',sans-serif;
}
.filter-select {
  flex:1; padding:5px 22px 5px 0;
  border:none; border-bottom:1px solid rgba(255,255,255,0.3);
  font-size:12px; font-weight:400; color:white;
  font-family:'Noto Sans JP',sans-serif;
  background:transparent; outline:none; cursor:pointer;
  appearance:none; -webkit-appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 10 10'%3E%3Cpath fill='rgba(255,255,255,0.6)' d='M5 7L0 2h10z'/%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-position:right 4px center;
  transition:border-color 0.2s;
}
.filter-select option { color:#1a1a1a; background:white; }
.filter-select:focus { border-bottom-color:white; }
.filter-divider { width:1px; height:18px; background:rgba(255,255,255,0.2); flex-shrink:0; }

/* ãƒ“ãƒ¥ãƒ¼åˆ‡æ›¿ */
.view-tabs {
  display:flex; gap:0;
  border-bottom:1px solid rgba(255,255,255,0.15);
}
.view-tab {
  flex:1; padding:9px 0;
  border:none; background:none;
  font-size:11px; font-weight:300; color:rgba(255,255,255,0.55);
  cursor:pointer; font-family:'Noto Sans JP',sans-serif;
  letter-spacing:0.06em;
  border-bottom:2px solid transparent;
  margin-bottom:-1px;
  transition:all 0.2s;
}
.view-tab.active { color:white; border-bottom-color:white; font-weight:700; }

/* JUMP NAV */
.jump-nav {
  display:flex; gap:14px;
  overflow-x:auto; padding:8px 0 10px;
  scrollbar-width:none;
}
.jump-nav::-webkit-scrollbar { display:none; }
.jump-btn {
  padding:0; border:none; background:none;
  font-size:11px; font-weight:300; color:rgba(255,255,255,0.6);
  cursor:pointer; white-space:nowrap; flex-shrink:0;
  font-family:'Noto Sans JP',sans-serif;
  letter-spacing:0.06em;
  border-bottom:1px solid transparent;
  transition:all 0.2s;
}
.jump-btn:hover, .jump-btn:active { color:white; border-bottom-color:rgba(255,255,255,0.6); }

/* ========== CONTENT ========== */
.content { padding:14px; max-width:480px; margin:0 auto; }

/* PURPOSE SECTION */
.purpose-section { margin-bottom:22px; }
.purpose-title {
  font-size:13px; font-weight:900;
  padding:7px 12px; border-radius:10px;
  margin-bottom:10px; display:inline-block;
}
.pt-dinner { background:rgba(232,131,58,0.12);  color:#b85e1a; }
.pt-daily  { background:rgba(61,122,120,0.12);  color:#2a6260; }
.pt-nana   { background:rgba(212,168,67,0.15);  color:#8a6400; }

/* STORE SECTION */
.store-section {
  background:white; border-radius:14px;
  box-shadow:0 2px 10px rgba(0,0,0,0.05);
  margin-bottom:10px; overflow:hidden;
}
.store-header {
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 12px; border-left:4px solid;
}
.store-name-wrap { display:flex; align-items:center; gap:7px; }
.store-name  { font-size:13px; font-weight:900; }
.store-count { font-size:11px; color:#BBB; }
.store-del-btn {
  background:none; border:none; font-size:11px; color:#DDD;
  cursor:pointer; padding:2px 6px; border-radius:5px;
  transition:all 0.2s; font-family:'Noto Sans JP',sans-serif;
}
.store-del-btn:hover { background:#FFF5F0; color:var(--warm1); }

/* ITEMS */
.item-list { padding:0 12px 2px; }
.item {
  display:flex; align-items:center; gap:9px;
  padding:8px 0; border-bottom:1px solid #F5F5F5;
  animation:slideIn 0.2s ease;
}
.item:last-child { border-bottom:none; }
@keyframes slideIn {
  from { opacity:0; transform:translateX(-10px); }
  to   { opacity:1; transform:translateX(0); }
}
.item-check {
  width:22px; height:22px; border-radius:50%;
  border:2px solid #DDD; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  font-size:11px; flex-shrink:0; transition:all 0.2s; background:white;
}
.item.done .item-check { background:var(--green); border-color:var(--green); color:white; }
.item-name { flex:1; font-size:14px; font-weight:700; min-width:0; word-break:break-all; }
.item.done .item-name { text-decoration:line-through; color:#CCC; font-weight:400; }
.item-meta { font-size:10px; color:#CCC; white-space:nowrap; flex-shrink:0; }
.item-del {
  background:none; border:none; font-size:13px;
  color:#DDD; cursor:pointer; padding:3px; transition:color 0.2s; flex-shrink:0;
}
.item-del:hover { color:var(--warm1); }
.drag-handle {
  color:#CCC; font-size:16px; cursor:grab; padding:3px 2px;
  flex-shrink:0; touch-action:none; user-select:none; -webkit-user-select:none;
}
.drag-handle:active { cursor:grabbing; }
.item.dragging {
  opacity:0.3;
}
.item.drag-over {
  border-top:3px solid var(--teal);
  background:#EAF4F4;
}

/* badge in list view */
.item-badge {
  font-size:10px; font-weight:700; padding:2px 7px;
  border-radius:99px; color:white; flex-shrink:0; white-space:nowrap;
}
.ib-dinner { background:var(--warm1); }
.ib-daily  { background:var(--teal); }
.ib-nana   { background:var(--warm2); }

/* ADD INPUT */
.add-row {
  display:flex; gap:6px;
  padding:8px 12px 10px; border-top:1px solid #F5F5F5; width:100%;
}
.add-input {
  flex:1; min-width:0;
  padding:7px 10px;
  border:2px solid #EEE; border-radius:9px;
  font-size:16px; font-family:'Noto Sans JP',sans-serif;
  background:#FAFAFA; outline:none; transition:border-color 0.2s;
}
.add-input:focus { border-color:var(--teal); background:white; }
.add-btn-small {
  width:36px; height:36px; flex-shrink:0;
  background:var(--teal);
  color:white; border:none; border-radius:9px;
  font-size:20px; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  transition:transform 0.15s;
  box-shadow:0 3px 8px rgba(61,122,120,0.3);
}
.add-btn-small:hover  { transform:scale(1.08); }
.add-btn-small:active { transform:scale(0.93); }
.mic-btn {
  width:36px; height:36px; flex-shrink:0;
  background:#F0F0F0; color:#888;
  border:none; border-radius:9px; font-size:16px; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  transition:all 0.15s; user-select:none; -webkit-user-select:none;
}
.mic-btn.recording {
  background:var(--warm1); color:white;
  animation:mic-pulse 0.8s infinite;
}
@keyframes mic-pulse {
  0%,100% { box-shadow:0 0 0 3px rgba(232,131,58,0.3); }
  50%      { box-shadow:0 0 0 6px rgba(232,131,58,0.1); }
}

.empty-store  { padding:10px 12px; font-size:12px; color:#CCC; text-align:center; }
.empty-global { text-align:center; padding:48px 20px; color:#CCC; font-size:14px; }
.empty-global .e-emoji { font-size:48px; margin-bottom:12px; }

/* SECTION DIVIDER (ä¸€è¦§) */
.list-divider {
  font-size:11px; font-weight:700; letter-spacing:1px;
  color:#BBB; padding:4px 2px 8px; text-transform:uppercase;
}

/* ADD STORE */
.add-store-btn {
  width:100%; padding:11px;
  background:white; border:2px dashed #DDD; border-radius:12px;
  font-size:12px; color:#AAA; cursor:pointer;
  font-family:'Noto Sans JP',sans-serif;
  display:flex; align-items:center; justify-content:center; gap:5px;
  transition:all 0.2s; margin-top:2px;
}
.add-store-btn:hover { border-color:var(--teal); color:var(--teal); }
.add-store-form {
  display:none; background:white; border-radius:12px;
  padding:12px; box-shadow:0 2px 12px rgba(0,0,0,0.08); margin-top:6px;
}
.add-store-form.open { display:block; }
.add-store-form label { font-size:11px; color:#AAA; font-weight:700; display:block; margin-bottom:7px; }
.add-store-row { display:flex; gap:6px; }
.add-store-input {
  flex:1; min-width:0; padding:8px 10px;
  border:2px solid #EEE; border-radius:9px;
  font-size:16px; font-family:'Noto Sans JP',sans-serif;
  outline:none; transition:border-color 0.2s;
}
.add-store-input:focus { border-color:var(--teal); }
.add-store-ok {
  padding:8px 12px; background:var(--teal); color:white;
  border:none; border-radius:9px; font-size:12px; font-weight:700;
  cursor:pointer; font-family:'Noto Sans JP',sans-serif; flex-shrink:0;
}
.add-store-cancel {
  padding:8px 8px; background:none; color:#AAA;
  border:none; font-size:12px; cursor:pointer; flex-shrink:0;
  font-family:'Noto Sans JP',sans-serif;
}

/* STORE COLORS â€” ãƒ†ã‚£ãƒ¼ãƒ«Ã—ã‚¦ã‚©ãƒ¼ãƒ  */
.sc0{border-color:var(--teal);}   .sn0{color:var(--teal);}
.sc1{border-color:var(--warm1);}  .sn1{color:var(--warm1);}
.sc2{border-color:var(--warm2);}  .sn2{color:var(--warm2);}
.sc3{border-color:var(--teal-lt);}.sn3{color:var(--teal-lt);}
.sc4{border-color:var(--warm3);}  .sn4{color:var(--warm3);}
.sc5{border-color:#AAA;}          .sn5{color:#AAA;}
```

  </style>
</head>
<body>

<div class="header">
  <!-- ã‚¿ã‚¤ãƒˆãƒ«ï¼‹çµ±è¨ˆ -->
  <div class="header-title-row">
    <div class="header-title">ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆ<span>todo list</span></div>
    <div class="stats-mini">
      <div class="stat-item">
        <div class="stat-num" id="statLeft">0</div>
        <div class="stat-lbl">æ®‹ã‚Š</div>
      </div>
      <div class="stat-sep"></div>
      <div class="stat-item">
        <div class="stat-num" id="statDone">0</div>
        <div class="stat-lbl">è³¼å…¥ãƒ»å¯¾å¿œæ¸ˆã¿</div>
      </div>
      <div class="stat-sep"></div>
      <div class="stat-item">
        <div class="stat-num" id="statTotal">0</div>
        <div class="stat-lbl">åˆè¨ˆ</div>
      </div>
    </div>
  </div>

  <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ï¼ˆ1pxç·šï¼‰ -->

  <div class="progress-bg"><div class="progress-bar" id="progressBar" style="width:0%"></div></div>

  <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->

  <div class="header-filter-row">
    <span class="filter-label">ç”¨é€”</span>
    <select class="filter-select" id="selPurpose" onchange="onFilterChange()">
      <option value="all">ã™ã¹ã¦</option>
    </select>
    <div class="filter-divider"></div>
    <span class="filter-label">åº—</span>
    <select class="filter-select" id="selStore" onchange="onFilterChange()">
      <option value="all">ã™ã¹ã¦</option>
    </select>
  </div>

  <!-- ãƒ“ãƒ¥ãƒ¼åˆ‡æ›¿ -->

  <div class="view-tabs" id="viewTabs">
    <button class="view-tab active" data-view="all"       onclick="switchView('all')">å…¨ä½“</button>
    <button class="view-tab"        data-view="shoplist"  onclick="switchView('shoplist')">ä¸€è¦§</button>
    <button class="view-tab"        data-view="purchased" onclick="switchView('purchased')">è³¼å…¥ãƒ»å¯¾å¿œæ¸ˆã¿</button>
  </div>

  <!-- ã‚¸ãƒ£ãƒ³ãƒ—ãƒŠãƒ“ -->

  <div class="jump-nav" id="jumpNav"></div>
</div>

<div class="content" id="mainContent"></div>

<script>
const PURPOSES = [
  { id:'dinner', label:'ğŸ¥• é£Ÿæ',           cls:'pt-dinner', ibcls:'ib-dinner' },
  { id:'daily',  label:'ğŸ§´ æ—¥ç”¨å“ãƒ»æ¶ˆè€—å“', cls:'pt-daily',  ibcls:'ib-daily'  },
  { id:'nana',   label:'ğŸ“ ã‚¿ã‚¹ã‚¯',         cls:'pt-nana',   ibcls:'ib-nana'   },
];
const STORE_EMOJIS = ['ğŸ›’','ğŸ¬','ğŸª','ğŸ›ï¸','ğŸ·ï¸','ğŸ“¦'];

function load() {
  const d = JSON.parse(localStorage.getItem('shopData_v6') || 'null') || {
    stores: [{ id:'s1', name:'è¥¿å‹' }, { id:'s2', name:'ã‚¢ãƒˆãƒ¬' }, { id:'task-store', name:'ã‚¿ã‚¹ã‚¯' }],
    items:  [],
    purchased: [],
  };
  if (!d.purchased) d.purchased = [];
  // task-storeã‚’æŒã¤é£Ÿæãƒ»æ—¥ç”¨å“ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤ï¼ˆèª¤æ··å…¥ãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼‰
  d.items = d.items.filter(i => !(i.storeId === 'task-store' && i.purposeId !== 'nana'));
  // task-storeãŒstoresã«å…¥ã£ã¦ã„ãŸã‚‰é™¤å»ï¼ˆstoresãƒªã‚¹ãƒˆã«ã¯ä¸è¦ï¼‰
  d.stores = d.stores.filter(s => s.id !== 'task-store');
  // 24æ™‚é–“ä»¥ä¸ŠçµŒéã—ãŸè³¼å…¥ãƒ»å¯¾å¿œæ¸ˆã¿ã‚¢ã‚¤ãƒ†ãƒ ã‚’è‡ªå‹•å‰Šé™¤
  const now = Date.now();
  d.purchased = d.purchased.filter(i => now - i.purchasedAt < 24 * 60 * 60 * 1000);
  return d;
}
function save(d) { localStorage.setItem('shopData_v6', JSON.stringify(d)); }

let data = load();
let currentView    = 'all';
let filterPurpose  = 'all';
let filterStore    = 'all';

/* ========== SELECTS ========== */
function rebuildSelects() {
  const sp = document.getElementById('selPurpose');
  const ss = document.getElementById('selStore');
  const pv = sp.value; const sv = ss.value;

  sp.innerHTML = '<option value="all">ã™ã¹ã¦</option>' +
    PURPOSES.map(p=>`<option value="${p.id}">${p.label}</option>`).join('');
  ss.innerHTML = '<option value="all">ã™ã¹ã¦</option>' +
    data.stores.filter(s=>s.id!=='task-store').map(s=>`<option value="${s.id}">${esc(s.name)}</option>`).join('');

  sp.value = pv; ss.value = sv;
  filterPurpose = sp.value;
  filterStore   = ss.value;
}

function onFilterChange() {
  filterPurpose = document.getElementById('selPurpose').value;
  filterStore   = document.getElementById('selStore').value;
  render();
}

/* ========== VIEW ========== */
function switchView(v) {
  currentView = v;
  document.querySelectorAll('.view-tab').forEach(t => {
    t.classList.toggle('active', t.dataset.view === v);
  });
  // ã‚¸ãƒ£ãƒ³ãƒ—ãƒŠãƒ“ã¯purchasedãƒ“ãƒ¥ãƒ¼ã§ã¯éè¡¨ç¤º
  document.getElementById('jumpNav').style.display = v === 'purchased' ? 'none' : '';
  render();
}

/* ========== JUMP NAV ========== */
function buildJumpNav() {
  const nav = document.getElementById('jumpNav');
  if (currentView !== 'all') { nav.innerHTML=''; return; }

  // è¡¨ç¤ºä¸­ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«å¿œã˜ã¦ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
  let btns = '';
  PURPOSES.forEach(p => {
    if (filterPurpose !== 'all' && filterPurpose !== p.id) return;
    btns += `<button class="jump-btn jb-${p.id}" onclick="jumpTo('sec-${p.id}')">${p.label}</button>`;
  });
  // åº—ã‚¸ãƒ£ãƒ³ãƒ—ï¼ˆå…¨ä½“è¡¨ç¤º & åº—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãªã—æ™‚ï¼‰
  if (filterStore === 'all') {
    data.stores.forEach(s => {
      if (filterPurpose === 'all') return; // ç”¨é€”æŒ‡å®šæ™‚ã®ã¿åº—ã‚¸ãƒ£ãƒ³ãƒ—å‡ºã™
      btns += `<button class="jump-btn jb-store" onclick="jumpTo('sec-store-${s.id}')">${esc(s.name)}</button>`;
    });
  }
  nav.innerHTML = btns;
}

/* ========== STATS ========== */
function renderStats() {
  const total = data.items.length;
  const purchased = data.purchased.length;
  document.getElementById('statTotal').textContent = total;
  document.getElementById('statLeft').textContent  = total;
  document.getElementById('statDone').textContent  = purchased;
  const pct = (total + purchased) ? Math.round(purchased / (total + purchased) * 100) : 0;
  document.getElementById('progressBar').style.width = pct+'%';
}

/* ========== RENDER ========== */
function render() {
  rebuildSelects();
  buildJumpNav();
  renderStats();
  if (currentView === 'shoplist') renderShopList();
  else if (currentView === 'purchased') renderPurchased();
  else renderAllView();
}

/* --- å…¨ä½“ãƒ“ãƒ¥ãƒ¼ --- */
function renderAllView() {
  let html = '';
  const showPurposes = PURPOSES.filter(p => filterPurpose==='all' || p.id===filterPurpose);
  const showStores   = data.stores.filter(s => (filterStore==='all' || s.id===filterStore) && s.id!=='task-store');

  showPurposes.forEach(p => {
    html += `<div class="purpose-section" id="sec-${p.id}">
      <div class="purpose-title ${p.cls}">${p.label}</div>`;

    // ã‚¿ã‚¹ã‚¯ã‚«ãƒ†ã‚´ãƒªã¯åº—ãªã—ã§ç›´æ¥è¡¨ç¤º
    if (p.id === 'nana') {
      const tItems = data.items.filter(i => i.purposeId === 'nana' && i.storeId === 'task-store');
      html += `<div class="store-section">
        <div class="item-list" id="list-nana-task-store">`;
      if (!tItems.length) {
        html += `<div class="empty-store">ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div>`;
      } else {
        tItems.forEach(item => { html += itemHTML(item, false); });
      }
      html += `</div>
        <div class="add-row">
          <input class="add-input" id="inp-nana-task-store"
            placeholder="ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›â€¦"
            onkeydown="if(event.key==='Enter')addItem('nana','task-store')">
          <button class="mic-btn" id="mic-nana-task-store"
            ontouchstart="startVoice(event,'nana','task-store')"
            ontouchend="stopVoice(event)"
            onmousedown="startVoice(event,'nana','task-store')"
            onmouseup="stopVoice(event)">ğŸ¤</button>
          <button class="add-btn-small" onclick="addItem('nana','task-store')">ï¼‹</button>
        </div>
      </div>`;
      html += `</div>`;
      return;
    }

    showStores.forEach((store) => {
      const ci    = data.stores.indexOf(store) % 6;
      const emoji = STORE_EMOJIS[data.stores.indexOf(store) % STORE_EMOJIS.length];
      const sItems = data.items.filter(i=>i.purposeId===p.id && i.storeId===store.id);

      html += `<div class="store-section" id="sec-store-${store.id}">
        <div class="store-header sc${ci}">
          <div class="store-name-wrap">
            <span class="store-name sn${ci}">${emoji} ${esc(store.name)}</span>
            <span class="store-count" id="cnt-${p.id}-${store.id}">${sItems.length}</span>
          </div>
          <button class="store-del-btn" onclick="deleteStore('${store.id}')">âœ•</button>
        </div>
        <div class="item-list" id="list-${p.id}-${store.id}">`;

      if (!sItems.length) {
        html += `<div class="empty-store">å•†å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div>`;
      } else {
        sItems.forEach(item => {
          html += itemHTML(item, false);
        });
      }

      html += `</div>
        <div class="add-row">
          <input class="add-input" id="inp-${p.id}-${store.id}"
            placeholder="å“åã‚’å…¥åŠ›â€¦"
            onkeydown="if(event.key==='Enter')addItem('${p.id}','${store.id}')">
          <button class="mic-btn" id="mic-${p.id}-${store.id}"
            ontouchstart="startVoice(event,'${p.id}','${store.id}')"
            ontouchend="stopVoice(event)"
            onmousedown="startVoice(event,'${p.id}','${store.id}')"
            onmouseup="stopVoice(event)">ğŸ¤</button>
          <button class="add-btn-small" onclick="addItem('${p.id}','${store.id}')">ï¼‹</button>
        </div>
      </div>`;
    });

    if (filterStore === 'all') {
      html += `
        <button class="add-store-btn" onclick="toggleStoreForm('${p.id}')">ï¼‹ ãŠåº—ã‚’è¿½åŠ </button>
        <div class="add-store-form" id="storeForm-${p.id}">
          <label>ğŸª æ–°ã—ã„ãŠåº—ã®åå‰</label>
          <div class="add-store-row">
            <input class="add-store-input" id="storeInput-${p.id}" placeholder="ä¾‹ï¼šãƒ‰ãƒ©ãƒƒã‚°ã‚¹ãƒˆã‚¢"
              onkeydown="if(event.key==='Enter')confirmStore('${p.id}')">
            <button class="add-store-ok" onclick="confirmStore('${p.id}')">è¿½åŠ </button>
            <button class="add-store-cancel" onclick="toggleStoreForm('${p.id}')">âœ•</button>
          </div>
        </div>`;
    }

    html += `</div>`;
  });

  if (!html) html = `<div class="empty-global"><div class="e-emoji">ğŸ”</div>è©²å½“ã™ã‚‹å•†å“ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
  document.getElementById('mainContent').innerHTML = html;
}

/* --- ä¸€è¦§ãƒ“ãƒ¥ãƒ¼ --- */
function renderShopList() {
  const allItems = data.items.filter(i => {
    if (filterPurpose !== 'all' && i.purposeId !== filterPurpose) return false;
    if (filterStore   !== 'all' && i.storeId   !== filterStore)   return false;
    return true;
  });

  if (!allItems.length) {
    document.getElementById('mainContent').innerHTML =
      `<div class="empty-global"><div class="e-emoji">ğŸ‰</div>è²·ã†ã‚‚ã®ã¯ã‚ã‚Šã¾ã›ã‚“ï¼</div>`;
    return;
  }

  let html = `<div class="list-divider">ğŸ›’ æœªè³¼å…¥ (${allItems.length}ä»¶)</div>`;
  html += `<div class="store-section"><div class="item-list">`;
  groupByStore(allItems).forEach(({ store, items }) => {
    const em = STORE_EMOJIS[data.stores.indexOf(store) % STORE_EMOJIS.length];
    html += `<div style="padding:6px 0 2px; font-size:11px; font-weight:900; color:var(--teal); border-bottom:1px solid #F0F0F0; margin-bottom:2px;">${em} ${esc(store.name)}</div>`;
    items.forEach(item => { html += itemHTML(item, true); });
  });
  html += `</div></div>`;

  document.getElementById('mainContent').innerHTML = html;
}

/* --- è³¼å…¥ãƒ»å¯¾å¿œæ¸ˆã¿ãƒ“ãƒ¥ãƒ¼ --- */
function renderPurchased() {
  const items = [...data.purchased].reverse(); // æ–°ã—ã„é †
  if (!items.length) {
    document.getElementById('mainContent').innerHTML =
      `<div class="empty-global"><div class="e-emoji">ğŸ›ï¸</div>è³¼å…¥ãƒ»å¯¾å¿œæ¸ˆã¿ã‚¢ã‚¤ãƒ†ãƒ ã¯ã‚ã‚Šã¾ã›ã‚“<br><span style="font-size:11px;color:#CCC">è³¼å…¥ã‹ã‚‰24æ™‚é–“å¾Œã«è‡ªå‹•å‰Šé™¤ã•ã‚Œã¾ã™</span></div>`;
    return;
  }

  let html = `<div style="text-align:right;font-size:11px;color:#BBB;padding:0 4px 8px;">è³¼å…¥ã‹ã‚‰24æ™‚é–“å¾Œã«è‡ªå‹•å‰Šé™¤</div>`;
  html += `<div class="store-section"><div class="item-list">`;
  items.forEach(item => {
    const p = PURPOSES.find(p=>p.id===item.purposeId);
    const store = data.stores.find(s=>s.id===item.storeId);
    const remaining = Math.max(0, Math.ceil((24*60*60*1000 - (Date.now() - item.purchasedAt)) / (60*60*1000)));
    html += `<div class="item done" id="item-${item.id}" data-id="${item.id}" style="opacity:0.75">
      <div class="item-check" style="background:var(--green);border-color:var(--green);color:white;font-size:11px;">âœ“</div>
      <div style="flex:1;min-width:0;">
        <div class="item-name" style="text-decoration:line-through;color:#BBB;font-weight:400;">${esc(item.name)}</div>
        <div style="font-size:10px;color:#CCC;">${store ? esc(store.name) : ''} Â· ${item.purchasedAtStr} Â· ã‚ã¨${remaining}æ™‚é–“</div>
      </div>
      ${p ? `<span class="item-badge ${p.ibcls}">${p.label.replace(/^../,'')}</span>` : ''}
      <button class="item-del" onclick="deletePurchased('${item.id}')">ğŸ—‘</button>
    </div>`;
  });
  html += `</div></div>`;
  document.getElementById('mainContent').innerHTML = html;
}

function deletePurchased(itemId) {
  data.purchased = data.purchased.filter(i=>i.id!==itemId);
  save(data);
  renderStats();
  renderPurchased();
}

function groupByStore(items) {
  const map = new Map();
  data.stores.forEach(s => map.set(s.id, { store:s, items:[] }));
  items.forEach(item => { if (map.has(item.storeId)) map.get(item.storeId).items.push(item); });
  return [...map.values()].filter(g=>g.items.length);
}

function itemHTML(item, showBadge) {
  const p = PURPOSES.find(p=>p.id===item.purposeId);
  return `<div class="item ${item.done?'done':''}" id="item-${item.id}" data-id="${item.id}">
    <div class="item-check" onclick="toggleItem('${item.id}')">${item.done?'âœ“':''}</div>
    <div class="item-name">${esc(item.name)}</div>
    ${showBadge && p ? `<span class="item-badge ${p.ibcls}">${p.label.replace(/^../,'')}</span>` : ''}
    ${item.done&&item.doneAt ? `<div class="item-meta">${item.doneAt}</div>` : ''}
    <button class="item-del" onclick="deleteItem('${item.id}')">ğŸ—‘</button>
  </div>`;
}

/* ========== DOM PATCH â€” ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãªã„æ›´æ–° ========== */

// ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ ã ã‘æ›´æ–°
function patchCounts(purposeId, storeId) {
  const el = document.getElementById('cnt-'+purposeId+'-'+storeId);
  if (!el) return;
  const sItems = data.items.filter(i=>i.purposeId===purposeId && i.storeId===storeId);
  el.textContent = sItems.length;
}

// ã‚¢ã‚¤ãƒ†ãƒ è¿½åŠ ï¼šè©²å½“ãƒªã‚¹ãƒˆã«ã ã‘è¦ç´ ã‚’è¿½åŠ 
function patchAddItem(purposeId, storeId, item) {
  const listEl = document.getElementById('list-'+purposeId+'-'+storeId);
  if (!listEl) { render(); return; }
  // ã€Œå•†å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€ã‚’æ¶ˆã™
  const empty = listEl.querySelector('.empty-store');
  if (empty) empty.remove();
  // æœªè³¼å…¥ã®æœ«å°¾ã«è¿½åŠ ï¼ˆå®Œäº†æ¸ˆã¿ã®å‰ï¼‰
  const doneItems = listEl.querySelectorAll('.item.done');
  const div = document.createElement('div');
  div.innerHTML = itemHTML(item, false);
  const newEl = div.firstElementChild;
  if (doneItems.length > 0) {
    listEl.insertBefore(newEl, doneItems[0]);
  } else {
    listEl.appendChild(newEl);
  }
  patchCounts(purposeId, storeId);
  renderStats();
}

// ã‚¢ã‚¤ãƒ†ãƒ å‰Šé™¤ï¼šè©²å½“è¦ç´ ã ã‘æ¶ˆã™
function patchDeleteItem(itemId, purposeId, storeId) {
  const el = document.getElementById('item-'+itemId);
  if (el) {
    el.remove();
    // ãƒªã‚¹ãƒˆãŒç©ºã«ãªã£ãŸã‚‰ã€Œè¿½åŠ ã—ã¦ãã ã•ã„ã€è¡¨ç¤º
    const listEl = document.getElementById('list-'+purposeId+'-'+storeId);
    if (listEl && !listEl.querySelector('.item')) {
      listEl.innerHTML = `<div class="empty-store">å•†å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div>`;
    }
  }
  patchCounts(purposeId, storeId);
  renderStats();
  if (currentView === 'shoplist') {
    const sy = window.scrollY;
    renderShopList();
    requestAnimationFrame(()=>window.scrollTo(0, sy));
  }
}

/* ========== ACTIONS ========== */
function jumpTo(secId) {
  const el = document.getElementById(secId);
  if (!el) return;
  const headerH = document.querySelector('.header').offsetHeight;
  window.scrollTo({ top: el.getBoundingClientRect().top + window.scrollY - headerH - 8, behavior:'smooth' });
}

function addItem(purposeId, storeId) {
  const key   = 'inp-'+purposeId+'-'+storeId;
  const input = document.getElementById(key);
  const name  = input ? input.value.trim() : '';
  if (!name) { if(input) input.focus(); return; }
  const item = { id:'i'+Date.now()+Math.random(), purposeId, storeId, name };
  data.items.push(item);
  input.value = '';
  save(data);
  patchAddItem(purposeId, storeId, item);
  input.focus();
}

function toggleItem(itemId) {
  const item = data.items.find(i=>i.id===itemId);
  if (!item) return;
  // å…¨ä½“ã‹ã‚‰å‰Šé™¤ã—ã¦è³¼å…¥ãƒ»å¯¾å¿œæ¸ˆã¿ã¸ç§»å‹•
  data.items = data.items.filter(i=>i.id!==itemId);
  const purchasedItem = {
    ...item,
    purchasedAt: Date.now(),
    purchasedAtStr: (()=>{ const n=new Date(); return `${n.getMonth()+1}/${n.getDate()} ${n.getHours()}:${String(n.getMinutes()).padStart(2,'0')}`; })()
  };
  data.purchased.push(purchasedItem);
  save(data);
  // å…¨ä½“ãƒ“ãƒ¥ãƒ¼ãªã‚‰å‰Šé™¤ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  const el = document.getElementById('item-'+itemId);
  if (el) {
    el.style.transition = 'opacity 0.3s, transform 0.3s';
    el.style.opacity = '0';
    el.style.transform = 'translateX(20px)';
    setTimeout(() => {
      const { purposeId, storeId } = item;
      patchDeleteItem(itemId, purposeId, storeId);
    }, 280);
  }
  renderStats();
}

function deleteItem(itemId) {
  const item = data.items.find(i=>i.id===itemId);
  if (!item) return;
  const { purposeId, storeId } = item;
  data.items = data.items.filter(i=>i.id!==itemId);
  save(data);
  patchDeleteItem(itemId, purposeId, storeId);
}

function deleteStore(storeId) {
  if (!confirm('ã“ã®ãŠåº—ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆå…¨ç”¨é€”ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ï¼‰')) return;
  data.stores = data.stores.filter(s=>s.id!==storeId);
  data.items  = data.items.filter(i=>i.storeId!==storeId);
  save(data); render();
}

function toggleStoreForm(purposeId) {
  const form = document.getElementById('storeForm-'+purposeId);
  if (!form) return;
  form.classList.toggle('open');
  if (form.classList.contains('open'))
    setTimeout(()=>{ const el=document.getElementById('storeInput-'+purposeId); if(el) el.focus(); }, 80);
}

function confirmStore(purposeId) {
  const input = document.getElementById('storeInput-'+purposeId);
  const name  = input ? input.value.trim() : '';
  if (!name) { if(input) input.focus(); return; }
  if (!data.stores.find(s=>s.name===name))
    data.stores.push({ id:'s'+Date.now(), name });
  save(data); render();
}

/* ========== ãƒ‰ãƒ©ãƒƒã‚°ä¸¦ã³æ›¿ãˆ ========== */
let dragState = null;

document.addEventListener('touchstart', dragStart, { passive: false });
document.addEventListener('touchmove',  dragMove,  { passive: false });
document.addEventListener('touchend',   dragEnd);
document.addEventListener('touchcancel',dragEnd);

function dragStart(e) {
  const item = e.target.closest('.item');
  if (!item || e.target.closest('.item-check') || e.target.closest('.item-del')) return;
  const itemId = item.dataset.id;
  if (!itemId) return;

  const timer = setTimeout(() => {
    if (navigator.vibrate) navigator.vibrate(40);
    const rect = item.getBoundingClientRect();
    const touch = e.touches[0];

    // ã‚´ãƒ¼ã‚¹ãƒˆç”Ÿæˆ
    const ghost = item.cloneNode(true);
    ghost.style.cssText = `position:fixed;left:${rect.left}px;top:${rect.top}px;width:${rect.width}px;z-index:9999;pointer-events:none;box-shadow:0 8px 24px rgba(0,0,0,0.25);border-radius:10px;background:white;opacity:0.95;transform:scale(1.02);`;
    document.body.appendChild(ghost);

    item.style.opacity = '0.3';

    dragState = {
      itemId,
      item,
      ghost,
      offsetY: touch.clientY - rect.top,
      listEl: item.closest('.item-list'),
      placeholder: null,
    };

    // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼ˆæŒ¿å…¥ä½ç½®è¡¨ç¤ºï¼‰
    const ph = document.createElement('div');
    ph.style.cssText = `height:3px;background:var(--teal);border-radius:2px;margin:2px 0;`;
    dragState.placeholder = ph;

  }, 180);

  dragState = { timer };
}

function dragMove(e) {
  if (!dragState) return;
  if (dragState.timer && !dragState.ghost) {
    // ã¾ã é•·æŠ¼ã—å¾…ã¡ä¸­ â†’ æŒ‡ãŒå‹•ã„ãŸã‚‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    clearTimeout(dragState.timer);
    dragState = null;
    return;
  }
  if (!dragState.ghost) return;
  e.preventDefault();

  const touch = e.touches[0];
  const { ghost, offsetY, listEl, placeholder, item } = dragState;

  // ã‚´ãƒ¼ã‚¹ãƒˆã‚’æŒ‡ã«è¿½å¾“
  ghost.style.top = (touch.clientY - offsetY) + 'px';

  // æŒ¿å…¥ä½ç½®ã‚’æ¢ã™
  const items = [...listEl.querySelectorAll('.item:not(.dragging-src)')];
  let insertBeforeEl = null;

  for (const el of items) {
    if (el === item) continue;
    const r = el.getBoundingClientRect();
    if (touch.clientY < r.top + r.height / 2) {
      insertBeforeEl = el;
      break;
    }
  }

  // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ç§»å‹•
  if (insertBeforeEl) {
    listEl.insertBefore(placeholder, insertBeforeEl);
  } else {
    listEl.appendChild(placeholder);
  }
  dragState.insertBeforeEl = insertBeforeEl;
}

function dragEnd() {
  if (!dragState) return;
  if (dragState.timer) clearTimeout(dragState.timer);
  if (!dragState.ghost) { dragState = null; return; }

  const { item, ghost, listEl, placeholder, insertBeforeEl } = dragState;

  // ã‚´ãƒ¼ã‚¹ãƒˆã¨ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼å‰Šé™¤
  ghost.remove();
  if (placeholder && placeholder.parentNode) placeholder.remove();
  item.style.opacity = '';

  // DOMä¸Šã§ä¸¦ã³æ›¿ãˆ
  if (insertBeforeEl) {
    listEl.insertBefore(item, insertBeforeEl);
  } else {
    listEl.appendChild(item);
  }

  // data.items ã‚’ DOMé †ã«åˆã‚ã›ã¦æ›´æ–°
  const newOrder = [...listEl.querySelectorAll('.item[data-id]')].map(el => el.dataset.id);
  const srcItem = data.items.find(i => i.id === dragState.itemId);
  if (srcItem) {
    // åŒã˜store+purposeã®ã‚¢ã‚¤ãƒ†ãƒ ã ã‘ä¸¦ã³æ›¿ãˆ
    const others = data.items.filter(i => !(i.storeId === srcItem.storeId && i.purposeId === srcItem.purposeId));
    const group  = data.items.filter(i =>   i.storeId === srcItem.storeId && i.purposeId === srcItem.purposeId);
    const sorted = newOrder.map(id => group.find(i => i.id === id)).filter(Boolean);
    // groupã«å«ã¾ã‚Œãªã„ã‚‚ã®ã¯ãã®ã¾ã¾
    const missing = group.filter(i => !sorted.find(s => s.id === i.id));
    data.items = [...others, ...sorted, ...missing];
    save(data);
  }

  dragState = null;
}

/* ========== éŸ³å£°å…¥åŠ› ========== */
let recognition = null;
let micBtn = null;

function startVoice(e, purposeId, storeId) {
  e.preventDefault();
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) { alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“'); return; }

  micBtn = document.getElementById('mic-'+purposeId+'-'+storeId);
  const input = document.getElementById('inp-'+purposeId+'-'+storeId);

  recognition = new SpeechRecognition();
  recognition.lang = 'ja-JP';
  recognition.continuous = false;
  recognition.interimResults = true;

  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    input.value = transcript;
  };

  recognition.onend = () => {
    if (micBtn) micBtn.classList.remove('recording');
  };

  recognition.onerror = () => {
    if (micBtn) micBtn.classList.remove('recording');
  };

  micBtn.classList.add('recording');
  recognition.start();
}

function stopVoice(e) {
  if (e) e.preventDefault();
  if (recognition) { recognition.stop(); recognition = null; }
  if (micBtn) { micBtn.classList.remove('recording'); micBtn = null; }
}

function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

render();
</script>

</body>
</html>